<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zeiterfassung">
    <meta name="theme-color" content="#4f46e5">
    
    <title>Zeiterfassung</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        input, select, textarea, button {
            font-size: 16px !important;
            -webkit-user-select: text;
            user-select: text;
        }
        
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%234f46e5' rx='40'/%3E%3Ctext x='90' y='120' font-size='90' text-anchor='middle' fill='white' font-family='Arial'%3E⏱%3C/text%3E%3C/svg%3E">
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Icon Components
        const Icon = ({ d, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {d}
            </svg>
        );
        
        const Play = (props) => <Icon d={<polygon points="5 3 19 12 5 21 5 3"/>} {...props} />;
        const Square = (props) => <Icon d={<rect x="3" y="3" width="18" height="18" rx="2"/>} {...props} />;
        const Plus = (props) => <Icon d={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} {...props} />;
        const Download = (props) => <Icon d={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} {...props} />;
        const Trash2 = (props) => <Icon d={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} {...props} />;
        const Clock = (props) => <Icon d={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} {...props} />;
        const Calendar = (props) => <Icon d={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>} {...props} />;
        const Users = (props) => <Icon d={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} {...props} />;
        const BarChart3 = (props) => <Icon d={<><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></>} {...props} />;
        const Edit2 = (props) => <Icon d={<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>} {...props} />;
        const ChevronDown = (props) => <Icon d={<polyline points="6 9 12 15 18 9"/>} {...props} />;
        const ChevronUp = (props) => <Icon d={<polyline points="18 15 12 9 6 15"/>} {...props} />;
        const Eye = (props) => <Icon d={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>} {...props} />;
        const EyeOff = (props) => <Icon d={<><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>} {...props} />;

        function TimeTracker() {
          const [projects, setProjects] = useState([]);
          const [teamMembers, setTeamMembers] = useState([]);
          const [currentUser, setCurrentUser] = useState(null);
          const [userProjectVisibility, setUserProjectVisibility] = useState({});
          const [dailyEntries, setDailyEntries] = useState([]);
          const [allEntries, setAllEntries] = useState([]);
          const [activeTimer, setActiveTimer] = useState(null);
          const [currentTime, setCurrentTime] = useState(Date.now());
          const [showAddProject, setShowAddProject] = useState(false);
          const [showAddMember, setShowAddMember] = useState(false);
          const [showUserSelect, setShowUserSelect] = useState(false);
          const [showManualEntry, setShowManualEntry] = useState(false);
          const [manualProjectId, setManualProjectId] = useState('');
          const [manualHours, setManualHours] = useState('');
          const [manualMinutes, setManualMinutes] = useState('');
          const [manualNote, setManualNote] = useState('');
          const [editingMember, setEditingMember] = useState(null);
          const [editingProject, setEditingProject] = useState(null);
          const [expandedProjects, setExpandedProjects] = useState({});
          const [newProjectName, setNewProjectName] = useState('');
          const [newProjectNote, setNewProjectNote] = useState('');
          const [newProjectBudget, setNewProjectBudget] = useState('');
          const [newMemberName, setNewMemberName] = useState('');
          const [newMemberRate, setNewMemberRate] = useState('');
          const [view, setView] = useState('projects');
          const [lastResetDate, setLastResetDate] = useState(null);

          const getTodayString = () => new Date().toISOString().split('T')[0];

          useEffect(() => {
            const interval = setInterval(() => {
              setCurrentTime(Date.now());
              const today = getTodayString();
              if (lastResetDate && lastResetDate !== today) {
                handleMidnightReset();
              }
            }, 1000);
            return () => clearInterval(interval);
          }, [lastResetDate, dailyEntries, activeTimer]);

          const handleMidnightReset = () => {
            if (activeTimer) {
              const entry = {
                id: Date.now().toString(),
                projectId: activeTimer.projectId,
                userId: activeTimer.userId,
                startTime: activeTimer.startTime,
                endTime: Date.now(),
                duration: Date.now() - activeTimer.startTime,
                date: lastResetDate,
                isManual: false
              };
              const updatedAll = [...allEntries, entry];
              setAllEntries(updatedAll);
              setActiveTimer(null);
            } else if (dailyEntries.length > 0) {
              const updatedAll = [...allEntries, ...dailyEntries];
              setAllEntries(updatedAll);
            }
            setDailyEntries([]);
            setLastResetDate(getTodayString());
          };

          useEffect(() => {
            const loadData = () => {
              try {
                const data = {
                  projects: localStorage.getItem('time-tracker-projects'),
                  members: localStorage.getItem('time-tracker-members'),
                  visibility: localStorage.getItem('time-tracker-visibility'),
                  currentUser: localStorage.getItem('time-tracker-current-user'),
                  daily: localStorage.getItem('time-tracker-daily-entries'),
                  all: localStorage.getItem('time-tracker-all-entries'),
                  active: localStorage.getItem('time-tracker-active'),
                  reset: localStorage.getItem('time-tracker-last-reset')
                };
                
                if (data.projects) setProjects(JSON.parse(data.projects));
                if (data.members) setTeamMembers(JSON.parse(data.members));
                if (data.visibility) setUserProjectVisibility(JSON.parse(data.visibility));
                if (data.currentUser) setCurrentUser(JSON.parse(data.currentUser));
                if (data.daily) setDailyEntries(JSON.parse(data.daily));
                if (data.all) setAllEntries(JSON.parse(data.all));
                if (data.active) setActiveTimer(JSON.parse(data.active));
                
                const today = getTodayString();
                const savedResetDate = data.reset || today;
                setLastResetDate(savedResetDate);
                
                if (savedResetDate !== today) {
                  setTimeout(() => handleMidnightReset(), 100);
                }

                if (data.members && !data.currentUser) {
                  const members = JSON.parse(data.members);
                  if (members.length > 0) {
                    setShowUserSelect(true);
                  }
                }
              } catch (error) {
                console.log('Keine gespeicherten Daten');
                setLastResetDate(getTodayString());
              }
            };
            loadData();
          }, []);

          useEffect(() => {
            try {
              localStorage.setItem('time-tracker-projects', JSON.stringify(projects));
              localStorage.setItem('time-tracker-members', JSON.stringify(teamMembers));
              localStorage.setItem('time-tracker-visibility', JSON.stringify(userProjectVisibility));
              if (currentUser) localStorage.setItem('time-tracker-current-user', JSON.stringify(currentUser));
              localStorage.setItem('time-tracker-daily-entries', JSON.stringify(dailyEntries));
              localStorage.setItem('time-tracker-all-entries', JSON.stringify(allEntries));
              localStorage.setItem('time-tracker-active', JSON.stringify(activeTimer));
              if (lastResetDate) localStorage.setItem('time-tracker-last-reset', lastResetDate);
            } catch (error) {
              console.error('Speicherfehler:', error);
            }
          }, [projects, teamMembers, dailyEntries, allEntries, activeTimer, lastResetDate, userProjectVisibility, currentUser]);

          const toggleProjectVisibility = (projectId) => {
            if (!currentUser) return;
            const key = `${currentUser.id}_${projectId}`;
            setUserProjectVisibility(prev => ({ ...prev, [key]: !(prev[key] ?? true) }));
          };

          const isProjectVisible = (projectId) => {
            if (!currentUser) return true;
            return userProjectVisibility[`${currentUser.id}_${projectId}`] ?? true;
          };

          const addProject = () => {
            if (newProjectName.trim()) {
              setProjects([...projects, {
                id: Date.now().toString(),
                name: newProjectName.trim(),
                note: newProjectNote.trim(),
                budget: parseFloat(newProjectBudget) || 0,
                color: `hsl(${Math.random() * 360}, 70%, 60%)`
              }]);
              setNewProjectName('');
              setNewProjectNote('');
              setNewProjectBudget('');
              setShowAddProject(false);
            }
          };

          const addManualEntry = () => {
            if (!currentUser || !manualProjectId) {
              alert('Bitte wähle ein Teammitglied und Projekt aus!');
              return;
            }
            const hours = parseInt(manualHours) || 0;
            const minutes = parseInt(manualMinutes) || 0;
            const totalMs = (hours * 3600 + minutes * 60) * 1000;
            if (totalMs === 0) {
              alert('Bitte gib eine Dauer ein!');
              return;
            }
            const now = Date.now();
            setDailyEntries([...dailyEntries, {
              id: Date.now().toString(),
              projectId: manualProjectId,
              userId: currentUser.id,
              startTime: now - totalMs,
              endTime: now,
              duration: totalMs,
              date: getTodayString(),
              isManual: true,
              note: manualNote.trim()
            }]);
            setManualProjectId('');
            setManualHours('');
            setManualMinutes('');
            setManualNote('');
            setShowManualEntry(false);
          };

          const updateProjectBudget = (projectId, budget) => {
            setProjects(projects.map(p => p.id === projectId ? { ...p, budget: parseFloat(budget) || 0 } : p));
            setEditingProject(null);
          };

          const addTeamMember = () => {
            if (newMemberName.trim()) {
              const newMember = {
                id: Date.now().toString(),
                name: newMemberName.trim(),
                hourlyRate: parseFloat(newMemberRate) || 0,
                color: `hsl(${Math.random() * 360}, 70%, 60%)`
              };
              setTeamMembers([...teamMembers, newMember]);
              setNewMemberName('');
              setNewMemberRate('');
              setShowAddMember(false);
              if (teamMembers.length === 0) setCurrentUser(newMember);
            }
          };

          const updateMemberRate = (memberId, rate) => {
            const updated = teamMembers.map(m => m.id === memberId ? { ...m, hourlyRate: parseFloat(rate) || 0 } : m);
            setTeamMembers(updated);
            if (currentUser?.id === memberId) setCurrentUser(updated.find(m => m.id === memberId));
            setEditingMember(null);
          };

          const deleteProject = (projectId) => {
            if (confirm('Projekt wirklich löschen?')) {
              setProjects(projects.filter(p => p.id !== projectId));
              if (activeTimer?.projectId === projectId) setActiveTimer(null);
            }
          };

          const deleteMember = (memberId) => {
            if (confirm('Teammitglied wirklich löschen?')) {
              setTeamMembers(teamMembers.filter(m => m.id !== memberId));
              if (currentUser?.id === memberId) setCurrentUser(null);
            }
          };

          const startTimer = (projectId) => {
            if (!currentUser) {
              alert('Bitte wähle zuerst ein Teammitglied aus!');
              setShowUserSelect(true);
              return;
            }
            if (activeTimer) stopTimer();
            setActiveTimer({ projectId, userId: currentUser.id, startTime: Date.now() });
          };

          const stopTimer = () => {
            if (activeTimer) {
              setDailyEntries([...dailyEntries, {
                id: Date.now().toString(),
                projectId: activeTimer.projectId,
                userId: activeTimer.userId,
                startTime: activeTimer.startTime,
                endTime: Date.now(),
                duration: Date.now() - activeTimer.startTime,
                date: getTodayString(),
                isManual: false
              }]);
              setActiveTimer(null);
            }
          };

          const formatDuration = (ms) => {
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            return `${h.toString().padStart(2, '0')}:${(m % 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
          };

          const getTodayProjectTime = (projectId) => {
            const entries = dailyEntries.filter(e => e.projectId === projectId && (!currentUser || e.userId === currentUser.id));
            const total = entries.reduce((sum, e) => sum + e.duration, 0);
            const active = activeTimer?.projectId === projectId && activeTimer?.userId === currentUser?.id ? currentTime - activeTimer.startTime : 0;
            return total + active;
          };

          const getProjectStats = (projectId) => {
            const projectEntries = [...allEntries, ...dailyEntries].filter(e => e.projectId === projectId);
            let totalMs = projectEntries.reduce((sum, e) => sum + e.duration, 0);
            if (activeTimer?.projectId === projectId) totalMs += currentTime - activeTimer.startTime;
            const totalHours = totalMs / 3600000;
            let totalCost = 0;
            const memberHours = {};
            projectEntries.forEach(entry => {
              const member = teamMembers.find(m => m.id === entry.userId);
              if (member) {
                const hours = entry.duration / 3600000;
                memberHours[member.id] = (memberHours[member.id] || 0) + hours;
                if (member.hourlyRate) totalCost += hours * member.hourlyRate;
              }
            });
            if (activeTimer?.projectId === projectId) {
              const member = teamMembers.find(m => m.id === activeTimer.userId);
              if (member) {
                const hours = (currentTime - activeTimer.startTime) / 3600000;
                memberHours[member.id] = (memberHours[member.id] || 0) + hours;
                if (member.hourlyRate) totalCost += hours * member.hourlyRate;
              }
            }
            return { totalHours, totalCost, memberHours };
          };

          const exportToExcel = () => {
            const data = allEntries.map(entry => {
              const project = projects.find(p => p.id === entry.projectId);
              const user = teamMembers.find(m => m.id === entry.userId);
              const hours = entry.duration / 3600000;
              const cost = user?.hourlyRate ? hours * user.hourlyRate : 0;
              return {
                Datum: entry.date || new Date(entry.startTime).toISOString().split('T')[0],
                Projekt: project?.name || 'Gelöscht',
                Notiz: entry.note || project?.note || '',
                Mitarbeiter: user?.name || 'Unbekannt',
                Stundensatz: user?.hourlyRate?.toFixed(2) || '0.00',
                Start: new Date(entry.startTime).toLocaleString('de-DE'),
                Ende: new Date(entry.endTime).toLocaleString('de-DE'),
                Dauer: formatDuration(entry.duration),
                'Dauer (Stunden)': hours.toFixed(2),
                'Kosten (€)': cost.toFixed(2),
                Art: entry.isManual ? 'Manuell' : 'Timer'
              };
            });
            const headers = Object.keys(data[0] || {});
            const csv = [headers.join('\t'), ...data.map(row => headers.map(h => row[h]).join('\t'))].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Zeiterfassung_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
          };

          const deleteEntry = (entryId) => setAllEntries(allEntries.filter(e => e.id !== entryId));

          const groupedEntries = allEntries.reduce((acc, entry) => {
            const date = entry.date || new Date(entry.startTime).toISOString().split('T')[0];
            if (!acc[date]) acc[date] = [];
            acc[date].push(entry);
            return acc;
          }, {});

          const sortedDates = Object.keys(groupedEntries).sort().reverse();
          const sortedProjects = [...projects].sort((a, b) => a.name.localeCompare(b.name));
          const visibleProjects = sortedProjects.filter(p => isProjectVisible(p.id));

          if (showUserSelect && teamMembers.length > 0) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 flex items-center justify-center">
                <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
                  <h2 className="text-2xl font-bold text-gray-800 mb-4 text-center">Wer bist du?</h2>
                  <p className="text-gray-600 mb-6 text-center">Wähle dein Profil aus</p>
                  <div className="space-y-3">
                    {teamMembers.map(member => (
                      <button
                        key={member.id}
                        onClick={() => { setCurrentUser(member); setShowUserSelect(false); }}
                        className="w-full p-4 rounded-xl border-2 border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all flex items-center gap-3"
                      >
                        <div className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style={{ backgroundColor: member.color }}>
                          {member.name.charAt(0).toUpperCase()}
                        </div>
                        <div className="text-left flex-1">
                          <div className="text-lg font-semibold text-gray-800">{member.name}</div>
                          {member.hourlyRate > 0 && <div className="text-sm text-gray-500">{member.hourlyRate}€/h</div>}
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-3">
              <div className="max-w-4xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg p-4 mb-3">
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2 flex-wrap">
                      <h1 className="text-2xl font-bold text-gray-800">Zeiterfassung</h1>
                      {currentUser && (
                        <div className="flex items-center gap-2 bg-indigo-50 px-3 py-1 rounded-lg">
                          <div className="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold" style={{ backgroundColor: currentUser.color }}>
                            {currentUser.name.charAt(0).toUpperCase()}
                          </div>
                          <span className="text-sm font-semibold text-indigo-700">{currentUser.name}</span>
                          <button onClick={() => setShowUserSelect(true)} className="text-indigo-500 hover:text-indigo-700 text-xs">
                            wechseln
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="grid grid-cols-4 gap-2">
                    {[
                      { id: 'projects', icon: <Clock size={14} />, label: 'Projekte' },
                      { id: 'overview', icon: <BarChart3 size={14} />, label: 'Übersicht' },
                      { id: 'history', icon: <Calendar size={14} />, label: 'Verlauf' },
                      { id: 'team', icon: <Users size={14} />, label: 'Team' }
                    ].map(tab => (
                      <button
                        key={tab.id}
                        onClick={() => setView(tab.id)}
                        className={`py-2 rounded-lg font-semibold transition-all text-xs ${view === tab.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 text-gray-600'}`}
                      >
                        <span className="inline mr-1">{tab.icon}</span>
                        {tab.label}
                      </button>
                    ))}
                  </div>
                </div>

                {view === 'projects' && (
                  <div className="space-y-2">
                    {visibleProjects.map(project => {
                      const isActive = activeTimer?.projectId === project.id && activeTimer?.userId === currentUser?.id;
                      const totalTime = getTodayProjectTime(project.id);
                      return (
                        <div key={project.id} className="bg-white rounded-xl shadow-md p-3">
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2">
                                <div className="w-3 h-3 rounded-full flex-shrink-0" style={{ backgroundColor: project.color }} />
                                <h3 className="text-base font-bold text-gray-800 truncate">{project.name}</h3>
                                <div className="text-lg font-mono font-bold text-indigo-600 ml-auto">{formatDuration(totalTime)}</div>
                              </div>
                              {project.note && <p className="text-xs text-gray-500 ml-5 truncate">{project.note}</p>}
                            </div>
                            <div className="flex gap-1 ml-2">
                              <button onClick={() => toggleProjectVisibility(project.id)} className="p-1.5 text-gray-500 hover:bg-gray-100 rounded-lg">
                                <EyeOff size={16} />
                              </button>
                              <button onClick={() => deleteProject(project.id)} className="p-1.5 text-red-500 hover:bg-red-50 rounded-lg">
                                <Trash2 size={16} />
                              </button>
                            </div>
                          </div>
                          <button
                            onClick={() => isActive ? stopTimer() : startTimer(project.id)}
                            className={`w-full py-2.5 rounded-lg font-bold text-sm transition-all shadow-sm ${isActive ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}`}
                          >
                            {isActive ? <><Square size={16} className="inline mr-1" /> Stop</> : <><Play size={16} className="inline mr-1" /> Start</>}
                          </button>
                        </div>
                      );
                    })}

                    {sortedProjects.filter(p => !isProjectVisible(p.id)).length > 0 && (
                      <div className="bg-white rounded-xl shadow-md p-3">
                        <h3 className="text-sm font-bold text-gray-600 mb-2">Ausgeblendete Projekte</h3>
                        {sortedProjects.filter(p => !isProjectVisible(p.id)).map(project => (
                          <div key={project.id} className="flex items-center justify-between p-2 bg-gray-50 rounded mb-1">
                            <div className="flex items-center gap-2">
                              <div className="w-2 h-2 rounded-full" style={{ backgroundColor: project.color }} />
                              <span className="text-sm
